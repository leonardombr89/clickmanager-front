<!-- Nova Variação (acordeon) -->
<mat-accordion [multi]="false" #accordion="matAccordion">
  <mat-expansion-panel #novaVarPanel class="cardWithShadow" [expanded]="false">
    <mat-expansion-panel-header>
      <mat-panel-title class="f-w-600">Nova Variação</mat-panel-title>
      <mat-panel-description class="f-s-14">
        Clique para preencher os campos
      </mat-panel-description>
    </mat-expansion-panel-header>

    <div *ngIf="formVariacaoAtual" class="p-16">

      <div class="row g-3 m-b-16">
        <div class="col-md-4">
          <app-auto-complete [control]="getFormControl(formVariacaoAtual.get('materialId'))" label="Material (opcional)"
            [displayWith]="mostrarDescricaoMaterial" [buscarFn]="buscarMateriais" [minimoCaracteres]="0"
            [multiplo]="false">
          </app-auto-complete>
        </div>

        <div class="col-md-4">
          <app-auto-complete [control]="getFormControl(formVariacaoAtual.get('formatoId'))" label="Formato (opcional)"
            [displayWith]="mostrarDescricaoFormato" [buscarFn]="buscarFormatos" [minimoCaracteres]="0"
            [multiplo]="false">
          </app-auto-complete>
        </div>

        <div class="col-md-4">
          <app-auto-complete [control]="getFormControl(formVariacaoAtual.get('tipoAplicacao'))"
            label="Tipo de Aplicação" [displayWith]="mostrarTipoAplicacao" [buscarFn]="buscarTiposAplicacao"
            [minimoCaracteres]="0" [multiplo]="false">
          </app-auto-complete>
        </div>

      </div>

      <div class="row g-3 m-b-16">
        <div class="col-md-12">
          <app-preco-selector [formGroup]="getFormGroup(formVariacaoAtual.get('preco')!)"
            [tiposDisponiveis]="['FIXO', 'QUANTIDADE', 'DEMANDA', 'METRO', 'HORA']">
          </app-preco-selector>
        </div>
      </div>

      <div class="row g-3 m-b-16">
        <div class="col-md-4">
          <mat-slide-toggle [formControl]="getFormControl(formVariacaoAtual.get('ativo'))">
            {{ formVariacaoAtual.get('ativo')?.value ? 'Variação Ativa' : 'Variação Inativa' }}
          </mat-slide-toggle>
        </div>
      </div>

      <div class="text-end">
        <button type="button" mat-flat-button color="primary" (click)="addVariacao()"
          [disabled]="formVariacaoAtual?.invalid || formVariacaoAtual.get('preco')?.invalid">
          <mat-icon>add</mat-icon>
          Adicionar Variação
        </button>
      </div>

    </div>
  </mat-expansion-panel>
</mat-accordion>

<!-- Tabela com variações salvas -->
<mat-card class="p-16 m-t-16 cardWithShadow">
  <mat-card-title class="f-s-16 f-w-600 m-b-16">Variações Salvas</mat-card-title>

  <table mat-table [dataSource]="dataSource" class="w-100 f-s-14">

    <!-- Material -->
    <ng-container matColumnDef="material">
      <th mat-header-cell *matHeaderCellDef>Material</th>
      <td mat-cell *matCellDef="let v">
        {{ v.materialId | nomeDe: materiais }}
      </td>
    </ng-container>

    <!-- Formato -->
    <ng-container matColumnDef="formato">
      <th mat-header-cell *matHeaderCellDef>Formato</th>
      <td mat-cell *matCellDef="let v">
        {{ v.formatoId | nomeDe: formatos }}
      </td>
    </ng-container>

    <!-- Tipo de Aplicação -->
    <ng-container matColumnDef="tipoAplicacao">
      <th mat-header-cell *matHeaderCellDef>Aplicação</th>
      <td mat-cell *matCellDef="let v">
        {{ mostrarTipoAplicacao(v.tipoAplicacao) || '—' }}
      </td>
    </ng-container>

    <!-- Preço -->
    <ng-container matColumnDef="preco">
      <th mat-header-cell *matHeaderCellDef>Preço</th>
      <td mat-cell *matCellDef="let v">
        {{ precoResumo(v.preco) }}
      </td>
    </ng-container>

    <!-- Ativo -->
    <ng-container matColumnDef="ativo">
      <th mat-header-cell *matHeaderCellDef>Ativo</th>
      <td mat-cell *matCellDef="let v">
        {{ v.ativo ? 'Sim' : 'Não' }}
      </td>
    </ng-container>

    <!-- Ações -->
    <ng-container matColumnDef="acoes">
      <th mat-header-cell *matHeaderCellDef></th>
      <td mat-cell *matCellDef="let v; let i = index">
        <button type="button" mat-icon-button color="warn" (click)="removerVariacao(i)">
          <mat-icon>delete</mat-icon>
        </button>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns; trackBy: trackByIndex">
    </tr>
  </table>
</mat-card>