<app-page-card titulo="Novo Pedido" botaoTexto="Voltar" botaoIcone="arrow_back" botaoCor="primary"
  [botaoRota]="['/page/pedido']" [mostrarDivisor]="true">

  <form [formGroup]="addForm">
    <div class="pedido-layout">
      <!-- Coluna esquerda: fluxo principal -->
      <div class="main-column">
          <!-- Cliente -->
          <app-section-card titulo="Cliente" [divider]="true">
            <div class="step-body">
              <app-auto-complete [control]="clienteControl" label="Selecionar cliente" [displayWith]="mostrarCliente"
                [buscarFn]="buscarClientes" [minimoCaracteres]="3" [multiplo]="false">
              </app-auto-complete>
              <button type="button" mat-stroked-button color="primary" class="m-t-8" (click)="onCriarCliente()">
                Novo cliente
              </button>
            </div>
          </app-section-card>

          <!-- Itens do pedido -->
          <app-itens-pedido-section
            [itens]="pedidoItens"
            [subtotal]="subTotal"
            (buscarProdutos)="onBuscarProdutos()"
            (descreverItens)="onDescreverItens()"
            (removerItem)="removerItem($event)"
            (alterarQuantidade)="alterarQuantidade($event.index, $event.quantidade)"
          ></app-itens-pedido-section>

          <!-- Observações -->
          <app-section-card titulo="Observações" [divider]="true">
            <div class="step-body">
              <app-input-textarea [control]="observacoesControl" label="Observações"
                placeholder="Insira observações relevantes sobre este pedido..." [rows]="3">
              </app-input-textarea>
              <div class="m-t-8" *ngIf="usuario$ | async as usuario">
                <mat-label class="f-s-13 f-w-600 d-block">Responsável:</mat-label>
                <p class="m-b-0">{{ usuario.nome }}</p>
              </div>
            </div>
          </app-section-card>
        </div>

        <!-- Coluna direita: ajustes, resumo, pagamentos, orçamento, ações -->
        <div class="summary-column">
          <div class="summary-sticky">
            <!-- Ajustes -->
            <app-section-card titulo="Ajustes" [divider]="true">
              <div class="step-body single-column">
                <app-input-moeda [control]="acrescimoControl" label="Acréscimo"></app-input-moeda>
                <app-input-moeda [control]="freteControl" label="Frete"></app-input-moeda>
                <app-input-moeda [control]="descontoControl" label="Desconto"></app-input-moeda>
              </div>
            </app-section-card>

            <!-- Resumo financeiro -->
            <app-section-card titulo="Resumo financeiro" [divider]="true" class="summary-card">
              <div class="summary-row">
                <span>Subtotal</span>
                <strong class="value">{{ subTotal | currency:'BRL':'symbol':'1.2-2' }}</strong>
              </div>
              <div class="summary-row">
                <span>Acréscimos</span>
                <strong class="value">{{ acrescimoControl.value || 0 | currency:'BRL':'symbol':'1.2-2' }}</strong>
              </div>
              <div class="summary-row">
                <span>Frete</span>
                <strong class="value">{{ freteControl.value || 0 | currency:'BRL':'symbol':'1.2-2' }}</strong>
              </div>
              <div class="summary-row">
                <span>Descontos</span>
                <strong class="value">{{ descontoControl.value || 0 | currency:'BRL':'symbol':'1.2-2' }}</strong>
              </div>
              <mat-divider class="m-t-8 m-b-8"></mat-divider>
              <div class="summary-row total">
                <span>Total</span>
                <strong class="value">{{ grandTotal | currency:'BRL':'symbol':'1.2-2' }}</strong>
              </div>
              <div class="summary-row resta">
                <span>Resta pagar</span>
                <strong class="value">{{ restaPagar | currency:'BRL':'symbol':'1.2-2' }}</strong>
              </div>
            </app-section-card>

            <!-- Pagamentos -->
            <app-pagamentos-section
              [pagamentoNovo]="pagamentoNovo"
              [pagamentosControls]="pagamentosControls"
              [formasPagamento]="formasPagamento"
              [pago]="totalPago"
              [restante]="restaPagar"
              (addPagamento)="addPagamento()"
              (removerPagamento)="removerPagamento($event)">
            </app-pagamentos-section>

            <!-- Orçamento (condicional) -->
            <app-section-card titulo="Orçamento" [divider]="true" *ngIf="orcamentoControl.value">
              <div class="step-body" [@expandCollapse]>
                <div class="text-danger f-s-13 m-b-12">
                  O pedido só será registrado após a aprovação do orçamento
                </div>
                <app-input-texto-restrito [control]="nomeOrcamentoControl" label="Nome do orçamento"
                  placeholder="Ex.: Cardápios do restaurante">
                </app-input-texto-restrito>
                <small class="text-muted">Utilize para facilitar a identificação</small>
                <div class="m-t-8">
                  <app-input-data [control]="vencimentoOrcamentoControl" label="Data de vencimento">
                  </app-input-data>
                  <small class="text-muted">Após esta data o cliente não poderá aprovar</small>
                </div>
              </div>
            </app-section-card>

            <!-- Ações finais -->
            <app-section-card>
              <div class="actions-final">
                <mat-checkbox [formControl]="orcamentoControl" class="f-w-600 f-s-13 m-b-8">
                  Salvar como orçamento
                </mat-checkbox>
                <div class="d-flex gap-8 flex-wrap">
                  <a routerLink="/page/pedido" mat-stroked-button color="warn">
                    Cancelar
                  </a>
                  <button mat-flat-button color="primary" (click)="saveDetail($event)"
                    [disabled]="addForm.invalid || !pedidoItens.length || !addForm.get('clienteId')?.value || (orcamentoControl.value && (!nomeOrcamentoControl.value || !vencimentoOrcamentoControl.value))">
                    Salvar pedido
                  </button>
                </div>
              </div>
            </app-section-card>
          </div>
      </div>
    </div>
  </form>
</app-page-card>
