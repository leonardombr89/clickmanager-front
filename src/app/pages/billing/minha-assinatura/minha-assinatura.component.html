<div *ngIf="acessoNegado" class="p-24">
  <mat-card class="cardWithShadow">
    <mat-card-content>
      <h3 class="f-w-700 m-b-8">Acesso restrito</h3>
      <p class="m-0 text-muted">Somente o proprietário pode visualizar os dados da assinatura.</p>
    </mat-card-content>
  </mat-card>
</div>

<div *ngIf="loading" class="d-flex justify-content-center m-t-24">
  <mat-progress-spinner mode="indeterminate" diameter="40"></mat-progress-spinner>
</div>

<div *ngIf="!loading && !acessoNegado" class="page-bg">
  <mat-card class="card alert-card m-b-16" *ngIf="mostrarAlertaCobranca">
    <mat-card-content>
      <div class="alert-card-content">
        <div class="alert-info">
          <mat-icon class="alert-icon">warning_amber</mat-icon>
          <div>
            <h3 class="alert-title">{{ alertTitle }}</h3>
            <p class="alert-subtitle">{{ alertSubtitle }}</p>
          </div>
        </div>
        <div class="alert-actions">
          <span class="urgency-badge">{{ urgencyBadge }}</span>
          <button mat-flat-button color="primary" *ngIf="mostrarAcaoRegularizacao" (click)="irParaPlanos()">
            Regularizar agora
          </button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <div class="content-grid">
    <mat-card class="card h-100">
      <mat-card-content>
        <div class="card-heading">
          <div>
            <h3 class="f-w-700 m-b-4">Minha assinatura</h3>
            <p class="text-muted m-b-0">{{ resumo?.planoNome }} ({{ resumo?.planoCodigo }})</p>
          </div>
          <button mat-stroked-button color="primary" *ngIf="podeTrocarPlano" (click)="irParaPlanos()">
            <mat-icon>swap_horiz</mat-icon>
            {{ ctaPlanoLabel }}
          </button>
        </div>

        <div class="assinatura-status-strip" *ngIf="resumo">
          <mat-chip selected [ngClass]="['status-chip', classeStatus]">{{ statusAssinatura }}</mat-chip>
          <div class="status-texts">
            <div class="f-w-600">{{ situacaoAssinatura }}</div>
            <div class="text-muted f-s-13" *ngIf="billingAccess?.expiresAt">
              Vencimento: {{ billingAccess?.expiresAt | date:'dd/MM/yyyy' }}
            </div>
          </div>
        </div>

        <div class="kpi-grid">
          <div class="kpi-card">
            <span class="kpi-label">Status</span>
            <span class="kpi-value">{{ resumo?.status || '-' }}</span>
          </div>
          <div class="kpi-card">
            <span class="kpi-label">Próxima cobrança</span>
            <span class="kpi-value">{{ resumo?.proximaCobrancaEm ? (resumo?.proximaCobrancaEm | date:'dd/MM/yyyy') : '—' }}</span>
          </div>
          <div class="kpi-card">
            <span class="kpi-label">Valor</span>
            <span class="kpi-value">{{ resumo?.valor | currency:(resumo?.moeda || 'BRL'):'symbol':'1.2-2':'pt-BR' }}</span>
          </div>
          <div class="kpi-card">
            <span class="kpi-label">Cliente desde</span>
            <span class="kpi-value">{{ resumo?.clienteDesde | date:'dd/MM/yyyy' }}</span>
          </div>
        </div>

        <dl class="assinatura-meta f-s-14 m-t-12">
          <div class="meta-row">
            <dt>Periodicidade</dt>
            <dd>{{ resumo?.periodicidade || '-' }}</dd>
          </div>
          <div class="meta-row">
            <dt>Início</dt>
            <dd>{{ resumo?.inicio | date:'dd/MM/yyyy' }}</dd>
          </div>
          <div class="meta-row">
            <dt>Fim</dt>
            <dd>{{ resumo?.fim | date:'dd/MM/yyyy' }}</dd>
          </div>
          <div class="meta-row">
            <dt>E-mail de cobrança</dt>
            <dd>{{ resumo?.emailCobranca || '-' }}</dd>
          </div>
        </dl>
      </mat-card-content>
    </mat-card>

    <mat-card class="card h-100">
      <mat-card-content>
        <h3 class="f-w-700 m-b-8">Recursos do plano</h3>
        <div class="feature-list" *ngIf="beneficios.length || limites.length; else noInfo">
          <div class="feature-item" *ngFor="let b of beneficios">
            <mat-icon>check_circle</mat-icon>
            <span>{{ b }}</span>
          </div>
          <div class="feature-item feature-limit" *ngFor="let l of limites">
            <mat-icon>task_alt</mat-icon>
            <span>{{ l }}</span>
          </div>
        </div>
        <ng-template #noInfo>
          <div class="empty-state">
            <mat-icon>info</mat-icon>
            <span>Nenhuma informação adicional.</span>
          </div>
        </ng-template>
      </mat-card-content>
    </mat-card>
  </div>

  <mat-card class="card m-t-16">
    <mat-card-content>
      <div class="card-heading m-b-8">
        <h3 class="f-w-700 m-0">Pagamentos</h3>
      </div>
      <div class="table-responsive">
        <table mat-table [dataSource]="pagamentos" class="w-100">
          <ng-container matColumnDef="valor">
            <th mat-header-cell *matHeaderCellDef>Valor</th>
            <td mat-cell *matCellDef="let p">{{ p.valor | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}</td>
          </ng-container>

          <ng-container matColumnDef="forma">
            <th mat-header-cell *matHeaderCellDef>Forma</th>
            <td mat-cell *matCellDef="let p">{{ resumo?.gateway || 'Gateway' }}</td>
          </ng-container>

          <ng-container matColumnDef="criado">
            <th mat-header-cell *matHeaderCellDef>Criado</th>
            <td mat-cell *matCellDef="let p">{{ p.criadoEm | date:'dd/MM/yyyy' }}</td>
          </ng-container>

          <ng-container matColumnDef="confirmado">
            <th mat-header-cell *matHeaderCellDef>Confirmado</th>
            <td mat-cell *matCellDef="let p">{{ p.confirmadoEm ? (p.confirmadoEm | date:'dd/MM/yyyy') : '—' }}</td>
          </ng-container>

          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let p">
              <mat-chip selected [ngClass]="['status-chip', getStatusClass(p.status)]">
                {{ getStatusLabel(p.status) }}
              </mat-chip>
            </td>
          </ng-container>

          <ng-container matColumnDef="referencia">
            <th mat-header-cell *matHeaderCellDef>Referência</th>
            <td mat-cell *matCellDef="let p">{{ p.referenciaExterna || '—' }}</td>
          </ng-container>

          <ng-container matColumnDef="link">
            <th mat-header-cell *matHeaderCellDef>Link</th>
            <td mat-cell *matCellDef="let p">
              <button
                mat-flat-button
                color="primary"
                *ngIf="p.invoiceUrl && statusPendente(p.status)"
                (click)="abrirLink(p.invoiceUrl)"
              >
                Pagar agora
              </button>
              <span *ngIf="!(p.invoiceUrl && statusPendente(p.status))">—</span>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;" [ngClass]="{ 'table-row-warning': isPendingRow(row) }"></tr>
        </table>
      </div>
      <div *ngIf="!pagamentos.length" class="text-muted f-s-13 m-t-12">Nenhum pagamento encontrado.</div>
    </mat-card-content>
  </mat-card>
</div>
