<div *ngIf="acessoNegado" class="p-24">
  <mat-card class="cardWithShadow">
    <mat-card-content>
      <h3 class="f-w-700 m-b-8">Acesso restrito</h3>
      <p class="m-0 text-muted">Somente o proprietário pode visualizar os dados da assinatura.</p>
    </mat-card-content>
  </mat-card>
</div>

<div *ngIf="loading" class="d-flex justify-content-center m-t-24">
  <mat-progress-spinner mode="indeterminate" diameter="40"></mat-progress-spinner>
</div>

<div *ngIf="!loading && !acessoNegado">
  <div class="row">
    <div class="col-md-6 m-b-16">
      <mat-card class="cardWithShadow h-100">
        <mat-card-content>
          <div class="card-heading">
            <div>
              <h3 class="f-w-700 m-b-4">Minha assinatura</h3>
              <p class="text-muted m-b-0">{{ resumo?.planoNome }} ({{ resumo?.planoCodigo }})</p>
            </div>
            <button mat-stroked-button color="primary" *ngIf="emTrial" (click)="irParaPlanos()">
              Escolher plano
            </button>
          </div>
          <dl class="assinatura-meta f-s-14">
            <div class="meta-row">
              <dt>Status</dt>
              <dd>{{ resumo?.status || '-' }}</dd>
            </div>
            <div class="meta-row">
              <dt>Periodicidade</dt>
              <dd>{{ resumo?.periodicidade || '-' }}</dd>
            </div>
            <div class="meta-row">
              <dt>Valor</dt>
              <dd>{{ resumo?.valor | currency:(resumo?.moeda || 'BRL'):'symbol':'1.2-2':'pt-BR' }}</dd>
            </div>
            <div class="meta-row">
              <dt>Próxima cobrança</dt>
              <dd>{{ resumo?.proximaCobrancaEm | date:'dd/MM/yyyy' }}</dd>
            </div>
            <div class="meta-row">
              <dt>Início</dt>
              <dd>{{ resumo?.inicio | date:'dd/MM/yyyy' }}</dd>
            </div>
            <div class="meta-row">
              <dt>Fim</dt>
              <dd>{{ resumo?.fim | date:'dd/MM/yyyy' }}</dd>
            </div>
            <div class="meta-row">
              <dt>E-mail de cobrança</dt>
              <dd>{{ resumo?.emailCobranca || '-' }}</dd>
            </div>
            <div class="meta-row">
              <dt>Cliente desde</dt>
              <dd>{{ resumo?.clienteDesde | date:'dd/MM/yyyy' }}</dd>
            </div>
          </dl>
        </mat-card-content>
      </mat-card>
    </div>

    <div class="col-md-6 m-b-16">
      <mat-card class="cardWithShadow h-100">
        <mat-card-content>
          <h3 class="f-w-700 m-b-8">Recursos do plano</h3>
          <div class="m-b-12" *ngIf="beneficios.length">
            <h5 class="f-s-14 f-w-700 m-b-4">Benefícios</h5>
            <ul class="m-0 p-l-16">
              @for (b of beneficios; track b) { <li>{{ b }}</li> }
            </ul>
          </div>
          <div *ngIf="limites.length">
            <h5 class="f-s-14 f-w-700 m-b-4">Limites</h5>
            <ul class="m-0 p-l-16">
              @for (l of limites; track l) { <li>{{ l }}</li> }
            </ul>
          </div>
          <div *ngIf="!beneficios.length && !limites.length" class="text-muted f-s-13">Nenhuma informação adicional.</div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <mat-card class="cardWithShadow">
    <mat-card-content>
      <h3 class="f-w-700 m-b-12">Pagamentos</h3>
      <div class="table-responsive">
        <table mat-table [dataSource]="pagamentos" class="w-100">
          <ng-container matColumnDef="valor">
            <th mat-header-cell *matHeaderCellDef>Valor</th>
            <td mat-cell *matCellDef="let p">{{ p.valor | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}</td>
          </ng-container>

          <ng-container matColumnDef="forma">
            <th mat-header-cell *matHeaderCellDef>Forma</th>
            <td mat-cell *matCellDef="let p">{{ resumo?.gateway || 'Gateway' }}</td>
          </ng-container>

          <ng-container matColumnDef="criado">
            <th mat-header-cell *matHeaderCellDef>Criado</th>
            <td mat-cell *matCellDef="let p">{{ p.criadoEm | date:'dd/MM/yyyy' }}</td>
          </ng-container>

          <ng-container matColumnDef="confirmado">
            <th mat-header-cell *matHeaderCellDef>Confirmado</th>
            <td mat-cell *matCellDef="let p">{{ p.confirmadoEm ? (p.confirmadoEm | date:'dd/MM/yyyy') : '—' }}</td>
          </ng-container>

          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let p">
              <mat-chip [color]="badgeColor(p.status)" selected>
                {{ p.status }}
              </mat-chip>
            </td>
          </ng-container>

          <ng-container matColumnDef="referencia">
            <th mat-header-cell *matHeaderCellDef>Referência</th>
            <td mat-cell *matCellDef="let p">{{ p.referenciaExterna || '—' }}</td>
          </ng-container>

          <ng-container matColumnDef="link">
            <th mat-header-cell *matHeaderCellDef>Link</th>
            <td mat-cell *matCellDef="let p">
              <button
                mat-stroked-button
                color="primary"
                *ngIf="p.invoiceUrl && statusPendente(p.status)"
                (click)="abrirLink(p.invoiceUrl)"
              >
                Abrir
              </button>
              <span *ngIf="!(p.invoiceUrl && statusPendente(p.status))">—</span>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </div>
      <div *ngIf="!pagamentos.length" class="text-muted f-s-13 m-t-12">Nenhum pagamento encontrado.</div>
    </mat-card-content>
  </mat-card>
</div>
